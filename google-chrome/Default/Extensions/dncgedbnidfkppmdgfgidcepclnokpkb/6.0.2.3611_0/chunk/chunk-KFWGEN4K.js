import{a as g}from"./chunk-PTKZDLN6.js";import{a,b as o,d as c,e as h,j as f}from"./chunk-SSPC3AL5.js";import{c as p}from"./chunk-LI3RKPGW.js";import{a as L}from"./chunk-3AUSJ54I.js";import{h as I}from"./chunk-CM6X6NVN.js";function u(i){this.message=i}u.prototype=new Error,u.prototype.name="InvalidCharacterError";var y=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(i){var t=String(i).replace(/=+$/,"");if(t.length%4==1)throw new u("'atob' failed: The string to be decoded is not correctly encoded.");for(var e,r,n=0,s=0,d="";r=t.charAt(s++);~r&&(e=n%4?64*e+r:r,n++%4)?d+=String.fromCharCode(255&e>>(-2*n&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return d};function S(i){var t=i.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(y(e).replace(/(.)/g,function(r,n){var s=n.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(t)}catch(e){return y(t)}}function l(i){this.message=i}function b(i,t){if(typeof i!="string")throw new l("Invalid token specified");var e=(t=t||{}).header===!0?0:1;try{return JSON.parse(S(i.split(".")[e]))}catch(r){throw new l("Invalid token specified: "+r.message)}}l.prototype=new Error,l.prototype.name="InvalidTokenError";var w=b;var E=I(L()),A=()=>{let i=t=>{let e=`${Math.random().toString(16)}000000000`.substr(2,8);return t?`-${e.substr(0,4)}-${e.substr(4,4)}`:e};return i()+i(!0)+i(!0)+i()},m=1e3*60*60*24,D=14,T=class{constructor(){this.errorType="",this.privilegedIframe=g(),this.canAdvertize=!(window.cordova&&E.default.layout==="WebKit"),this.license=this.privilegedIframe?{name:"Vernier Studio"}:void 0,this.pending=!1,this.encryptedLicense=void 0,this.authFormDismissed=!1,this.lastGoodKey=void 0,f(this,{license:a,lastGoodKey:a,pending:a,errorType:a,authFormDismissed:a,authorized:o,showAuthForm:o,licenseName:o,licenseExpiration:o,authorizationAvailable:o,daysRemaining:o,authorize:c,resetErrorType:c,dismissForm:c,clearLicense:c,setEncryptedLicense:c}),this.privilegedIframe||this.syncFromLocalStorage()}syncFromLocalStorage(){requestAnimationFrame(()=>{localStorage?.getItem?h(()=>{this.authFormDismissed=localStorage.getItem("authFormDismissed")==="true",this.setEncryptedLicense(localStorage.getItem("ga_license")),this.lastGoodKey=localStorage.getItem("goodKey"),setTimeout(()=>{this.verifyLicense()},2e3)}):this.syncFromLocalStorage()})}verifyLicense(){this.encryptedLicense&&navigator.onLine&&this.license.seed<Date.now()+D*m-m&&this.authorize(this.license.key)}get authorizationAvailable(){return!this.privilegedIframe}get showAuthForm(){return!this.license&&!this.authFormDismissed&&!this.privilegedIframe}get authorized(){return Boolean(this.privilegedIframe||this.license)}get licenseName(){return this.license?.name?this.license?.name:p("Unknown")}get licenseExpiration(){return this.license?.expires?new Date(this.license?.expires).toDateString():p("No expiration date")}get daysRemaining(){if(this.license?.expires){let e=new Date(this.license?.expires).getTime(),r=Date.now(),n=Math.abs(e-r);return Math.ceil(n/m)}return 1/0}setEncryptedLicense(t){let e=Date.now();if(this.encryptedLicense=t,this.encryptedLicense){let r=w(this.encryptedLicense);r.seed<e?this.clearLicense():(this.license=r,localStorage.setItem("ga_license",this.encryptedLicense))}}async authorize(t){try{if(this.pending=!0,t==="")throw this.errorType="empty",this.clearLicense(),new Error("empty");let e=localStorage.getItem("id");e||(e=A(),localStorage.setItem("id",e));let r=await fetch("https://xvfdsz97i8.execute-api.us-west-2.amazonaws.com/default/lookup-key",{method:"POST",body:JSON.stringify({product:"ga",key:t,channel:"release",fingerprint:e,seed:Date.now()}),headers:{"Content-type":"application/json"}}),n=await r.json();this.clearLicense(),h(()=>{if(r.status===200){let{key:s,license:d,eula:v}=n;if(this.lastGoodKey=s,localStorage.setItem("goodKey",s),v)this.setEncryptedLicense(d);else throw this.errorType="eula",new Error("eula")}if(r.status===400)throw this.errorType="empty",new Error("empty");if(r.status===401){let{message:s}=n;switch(s){case"is expired":this.errorType="expired";break;case"is suspended":this.errorType="suspended";break;default:this.errorType="invalid"}throw new Error("invalid")}if(r.status===500){let{error:s}=n;switch(s){case"Wrong Product":this.errorType="wrongProduct",(t.startsWith("VVA-")||t.startsWith("GAP-"))&&(this.errorType="activationCode");break;case"Wrong Channel":this.errorType="wrongChannel";break;default:this.errorType="unknown"}throw new Error("invalid")}this.pending=!1})}catch(e){throw h(()=>{this.pending=!1,this.errorType===""&&(this.errorType="unknown")}),console.error(e),e}}dismissForm(){this.authFormDismissed=!0,localStorage.setItem("authFormDismissed",!0)}resetErrorType(){this.errorType=""}async validateLicense(t){let e=!1;if(this.encryptedLicense)try{await t(this.encryptedLicense),e=!0}catch(r){this.clearLicense()}return e}clearLicense(){this.encryptedLicense=void 0,this.license=void 0,this.authFormDismissed=!1,this.errorType="",localStorage.setItem("authFormDismissed",!1),localStorage.removeItem("ga_license")}},k=new T;export{k as a};
